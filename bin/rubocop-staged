#!/usr/bin/env bash

# Get list of staged Ruby files (added or modified)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=AM | grep -E '\.rb$')

if [ -z "$STAGED_FILES" ]; then
  echo "No staged Ruby files to lint"
  exit 0
fi

echo "Running RuboCop on staged files..."

# Run rubocop with auto-correct on staged files
# --except Metrics skips complexity metrics which can be noisy
# --force-exclusion ensures .rubocop.yml exclusions are respected
bin/rubocop --except Metrics --autocorrect --force-exclusion $STAGED_FILES

if [ $? -ne 0 ]; then
  echo "RuboCop found issues that could not be auto-corrected"
  exit 1
fi

# Re-stage files that were auto-corrected
echo "$STAGED_FILES" | xargs git add

echo "RuboCop passed!"
